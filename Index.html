<!DOCTYPE html>
<html>
<head>
  <base target="_top">
  <title>Subir Imágenes a Drive</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      max-width: 500px;
      margin: 0 auto;
      padding: 20px;
    }
    #preview {
      max-width: 100%;
      max-height: 300px;
      display: none;
      margin: 15px 0;
      border: 2px dashed #ccc;
      border-radius: 5px;
    }
    button {
      background-color: #4285f4;
      color: white;
      border: none;
      padding: 10px 15px;
      margin: 5px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 14px;
    }
    button:disabled {
      background-color: #cccccc;
    }
    #message {
      margin: 15px 0;
      padding: 10px;
      border-radius: 4px;
    }
    .success {
      background-color: #e6f4ea;
      color: #137333;
    }
    .error {
      background-color: #fce8e6;
      color: #d93025;
    }
  </style>
</head>
<body>
  <h1>Subir Imagen a Google Drive</h1>
  
  <div>
    <button onclick="selectFile()">Seleccionar Archivo</button>
    <button onclick="captureFromCamera()">Usar Cámara</button>
  </div>
  
  <img id="preview">
  
  <div>
    <button onclick="upload()" id="uploadBtn" disabled>Subir a Drive</button>
  </div>
  
  <div id="message"></div>
  
  <script>
    let selectedFile = null;
    
    // 1. Seleccionar archivo del dispositivo
    function selectFile() {
      const input = document.createElement('input');
      input.type = 'file';
      input.accept = 'image/*';
      
      input.onchange = e => {
        const file = e.target.files[0];
        if (file) {
          processImageFile(file);
        }
      };
      
      input.click();
    }
    
    // 2. Capturar desde la cámara
    function captureFromCamera() {
      const input = document.createElement('input');
      input.type = 'file';
      input.accept = 'image/*';
      input.capture = 'camera'; // Especifica que queremos la cámara
      
      input.onchange = e => {
        const file = e.target.files[0];
        if (file) {
          processImageFile(file);
        }
      };
      
      input.click();
    }
    
    // 3. Procesar la imagen seleccionada
    function processImageFile(file) {
      const reader = new FileReader();
      
      reader.onload = function(event) {
        selectedFile = event.target.result;
        document.getElementById('preview').src = selectedFile;
        document.getElementById('preview').style.display = 'block';
        document.getElementById('uploadBtn').disabled = false;
        document.getElementById('message').textContent = '';
      };
      
      reader.readAsDataURL(file);
    }
    
    // 4. Subir a Drive
    function upload() {
      if (!selectedFile) return;
      
      const uploadBtn = document.getElementById('uploadBtn');
      uploadBtn.disabled = true;
      uploadBtn.textContent = 'Subiendo...';
      
      const messageDiv = document.getElementById('message');
      messageDiv.textContent = 'Subiendo imagen, por favor espera...';
      messageDiv.className = '';
      
      // Generar nombre de archivo con fecha
      const fileName = 'imagen_' + formatDate(new Date()) + '.jpg';
      
      google.script.run
        .withSuccessHandler(response => {
          if (response.success) {
            messageDiv.innerHTML = 
              `<span class="success">¡Imagen subida correctamente!</span><br>
               <a href="${response.url}" target="_blank">Abrir en Drive</a>`;
            document.getElementById('preview').style.display = 'none';
            selectedFile = null;
          } else {
            messageDiv.innerHTML = 
              `<span class="error">Error al subir: ${response.error}</span>`;
          }
          uploadBtn.disabled = false;
          uploadBtn.textContent = 'Subir a Drive';
        })
        .withFailureHandler(error => {
          messageDiv.innerHTML = 
            `<span class="error">Error: ${error.message}</span>`;
          uploadBtn.disabled = false;
          uploadBtn.textContent = 'Subir a Drive';
        })
        .uploadFileToDrive(selectedFile, fileName);
    }
    
    // Función auxiliar para formato de fecha
    function formatDate(date) {
      return date.getFullYear() + 
             ('0' + (date.getMonth() + 1)).slice(-2) + 
             ('0' + date.getDate()).slice(-2) + '_' + 
             ('0' + date.getHours()).slice(-2) + 
             ('0' + date.getMinutes()).slice(-2) + 
             ('0' + date.getSeconds()).slice(-2);
    }
  </script>
</body>
</html>